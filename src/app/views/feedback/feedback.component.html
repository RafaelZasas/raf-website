
<div class="container center">

  <div class="row">
    <form [formGroup]="feedbackForm" (ngSubmit)="submitFeedback()">

      <div class="row center">
        <label class="col s12 m4 l4 xl4">
          <select formControlName="feedbackType">
            <option value="" disabled selected>Feedback Type:</option>
            <option value="Feature Request"><span class="blue-text">Feature Request</span></option>
            <option value="Bug Report"><span class="materialize-red-text">Bug Report</span></option>
            <option value="General Feedback">General Feedback</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label class="active" for="txtFeedback">Message:</label>
        <textarea
          type="text"
          id="txtFeedback"
          formControlName="feedbackMessage"
          class="col s12 materialize-textarea validate"
          data-length="120">
    </textarea>
      </div>

      <div class="row" *ngIf="auth.user$ | async as user; then authenticated else guest">
        <!-- CORRESPONDING BUTTON WILL GO HERE -->
      </div>

      <ng-template #authenticated>
        <button
          class="btn waves-effect light-blue"
          type="submit">Submit
          <i class="material-icons right">send</i>
        </button>
      </ng-template>

      <ng-template #guest>
        <button
          class="btn waves-effect light-blue"
          type="submit" routerLink="/login">Login to submit feedback
        </button>
      </ng-template>
    </form>
  </div>
</div>

<div class="row" *ngIf="showPostsSpinner">
  <app-loading-spinner></app-loading-spinner>
</div>

<!--         SECTION FOR ALL USERS TO SEE FEEDBACK MESSAGES   -->
<div class="container">
  <div class="card" *ngFor="let message of feedbackPostService.feedbackMessages | async">
    <div class="card-content">

      <div class="row">

        <!-- row for message type  -->
        <span class="card-title text-darken-4"
              [class.red-text]="message.feedbackType== 'Bug Report'"
              [class.light-blue-text]="message.feedbackType=='Feature Request'">
              {{message.feedbackType}}
        </span>
        <i class="material-icons right activator"
           data-target='dropdown'
           style="cursor:pointer;"
           *ngIf="this.auth.user$"
           (click)="this.setPost(message)">more_vert</i>

        <div class="row">

            <img src="{{message.profilePhoto}}" alt="profilePhoto" class="feedback-avatar">
          <div style="padding-left: 50px">
            <p class="title">{{message.username}}</p>
            <p> {{message.feedbackMessage}}</p>
          </div>
        </div>

        <a class="subheader modal-trigger"
           data-target="repliesModal"
           style="cursor: pointer"
           (click)="showReplies(message.postID)">show replies</a>


          <div class="row no-pad-bot" *ngIf="this.auth.user$| async as user"
          style="padding-top: 25px">

            <div class="col" *ngIf="auth.canEdit(user)">
              <a class="btn btn-small rounded light-blue modal-trigger"
                 style="padding-right: 10px"
                 data-target="replyModal"
                 (click)="replyingTo=message.postID">
                <fa-icon [icon]="reply"></fa-icon>
                Reply
              </a>
            </div>

            <div class="col" *ngIf="auth.canDelete(user)">
              <a class="btn btn-small rounded materialize-red"
                 style="padding-right: 10px"
                 (click)="this.feedbackPostService.deletePost(message.postID)">
                <fa-icon [icon]="trash"></fa-icon>
                Delete
              </a>
            </div>

            <div class="col" *ngIf="auth.canEdit(user)">
              <a class="btn btn-small rounded green">
                <fa-icon [icon]="edit"></fa-icon>
                Edit
              </a>
            </div>
          </div>

        </div>

    </div>
  </div>
</div>


<!-- Show Replies modal -->
<div id="repliesModal" class="modal">

  <div class="row center-block">
    <app-loading-spinner *ngIf="this.showSpinner"></app-loading-spinner>
  </div>

  <div class="modal-content">
    <div class="col" *ngIf="this.hasReplies; else no_content">
      <ul class="collection">
        <li *ngFor="let reply of feedbackPostService.feedbackReplies |async "
            class="collection-item avatar">
          <img src="{{reply.profilePhoto}}" alt="profile-photo" class="circle">
          <span class="title"> {{reply.username}}</span>
          <p class=" helper-text">{{reply.message}}</p>
        </li>
      </ul>
    </div>
    <ng-template #no_content>
      <p>No replies</p>
    </ng-template>

  </div>
  <div class="modal-footer">
    <button
      class="btn modal-close light-blue"
      type="submit">close
    </button>
  </div>
</div>


<!-- Reply to feedback modal -->
<div id="replyModal" class="modal">
  <form [formGroup]="replyForm" (ngSubmit)="replyToPost()">
    <div class="modal-content">
      <label class="active" for="txtReply">Reply:</label>
      <textarea
        type="text"
        formControlName="message"
        id="txtReply"
        class="col s12 materialize-textarea validate"
        data-length="120">
     </textarea>
    </div>
    <div class="modal-footer">
      <button
        [disabled]="!replyForm.valid"
        class="btn modal-close light-blue"
        type="submit">reply
      </button>

    </div>
  </form>
</div>



